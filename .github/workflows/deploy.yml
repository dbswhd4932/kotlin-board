name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ] # main 브랜치에 코드가 올라오면 실행

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest # GitHub가 제공하는 컴퓨터 사용

    steps:
      # ========================================
      # CI: 빌드 & 도커 이미지 생성
      # ========================================
      - name: 코드 가져오기
        uses: actions/checkout@v3

      - name: JDK 17 설치
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Gradle 빌드 (테스트 제외)
        run: ./gradlew bootJar -x test

      - name: 도커 허브 로그인
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 도커 이미지 빌드 및 푸시
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/kotlin-board:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/kotlin-board:latest

      # ========================================
      # CD: EC2 서버에 자동 배포
      # ========================================
      - name: SSH 키 디코딩 및 설정
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key.pem
          chmod 600 ~/.ssh/deploy_key.pem
          # 키 형식 확인
          head -n 1 ~/.ssh/deploy_key.pem

      - name: EC2 서버에 SSH 접속 및 배포
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          command_timeout: 10m
          debug: true
          script: |
            # 프로젝트 디렉토리로 이동
            cd ~/kotlin-board-example

            # Docker Hub에서 최신 이미지 가져오기
            docker-compose -f docker-compose.prod.yml pull app

            # 컨테이너 재시작 (다운타임 최소화)
            docker-compose -f docker-compose.prod.yml up -d app

            # 사용하지 않는 이전 이미지 정리
            docker image prune -af

            # 배포 완료 확인
            echo "========================================="
            echo "배포 완료: $(date)"
            echo "========================================="
            docker ps --filter "name=kotlin-board"